---
import { languages, type Language } from '../utils/i18n';

interface Props {
  currentLang: Language;
  availableLanguages?: Language[];
  postSlug?: string;
  getTargetUrl: (lang: Language) => string;
}

const { currentLang, availableLanguages, postSlug, getTargetUrl } = Astro.props;
---

<div class="language-dropdown" data-dropdown>
  <button
    type="button"
    class="dropdown-trigger"
    aria-haspopup="true"
    aria-expanded="false"
    data-dropdown-trigger
    aria-label={`Language: ${languages[currentLang]}`}
  >
    <svg class="globe-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 56 56" aria-hidden="true"><path fill="currentColor" d="M28.023 51.273c12.727 0 23.25-10.546 23.25-23.273C51.274 15.297 40.727 4.727 28 4.727S4.727 15.297 4.727 28c0 12.727 10.57 23.273 23.296 23.273m-6.75-35.414c1.383-3.492 3.282-6 5.368-6.773v7.312a34 34 0 0 1-5.368-.539m8.063-6.773c2.086.773 4.008 3.281 5.367 6.773a34 34 0 0 1-5.367.54Zm4.945.656c2.508.867 4.782 2.203 6.68 3.961c-1.031.586-2.227 1.078-3.563 1.5c-.843-2.18-1.922-4.031-3.117-5.46m-19.265 3.961a19.5 19.5 0 0 1 6.703-3.96c-1.219 1.429-2.274 3.28-3.14 5.46c-1.313-.422-2.509-.914-3.563-1.5m24.609 12.938c-.117-3.258-.61-6.282-1.383-8.953c1.758-.54 3.305-1.22 4.617-2.016c2.485 3 4.102 6.797 4.383 10.969Zm-30.867 0a19.05 19.05 0 0 1 4.383-10.97c1.289.798 2.859 1.477 4.593 2.017c-.773 2.671-1.242 5.695-1.359 8.953Zm20.578 0v-7.547a37 37 0 0 0 6.234-.727a36.2 36.2 0 0 1 1.29 8.274Zm-10.195 0a33.8 33.8 0 0 1 1.289-8.274c1.922.399 4.03.656 6.21.727v7.547ZM8.758 29.336h7.617c.094 3.305.586 6.398 1.36 9.094c-1.712.539-3.258 1.195-4.547 1.992a19.3 19.3 0 0 1-4.43-11.086m10.36 0h7.523v7.687c-2.18.07-4.29.305-6.211.727c-.727-2.531-1.196-5.414-1.313-8.414m10.218 7.687v-7.687h7.523c-.093 3-.562 5.883-1.289 8.414c-1.945-.422-4.031-.656-6.234-.727m8.906 1.407c.797-2.696 1.266-5.79 1.383-9.094h7.617a18.9 18.9 0 0 1-4.43 11.086c-1.289-.774-2.835-1.453-4.57-1.992m-16.969 1.828a34 34 0 0 1 5.368-.54v7.313c-2.086-.773-3.985-3.281-5.368-6.773m8.063-.54c1.945.048 3.727.235 5.367.54c-1.36 3.492-3.281 6-5.367 6.773Zm-14.25 2.65a19 19 0 0 1 3.492-1.454c.844 2.11 1.852 3.89 3.024 5.32a19.1 19.1 0 0 1-6.516-3.867m22.312-1.454q1.97.597 3.516 1.477a19.2 19.2 0 0 1-6.539 3.867c1.172-1.43 2.203-3.235 3.023-5.344"/></svg>
    <svg
      class="dropdown-arrow"
      width="12"
      height="12"
      viewBox="0 0 12 12"
      fill="none"
      aria-hidden="true"
    >
      <path d="M2 4L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <div class="dropdown-menu" data-dropdown-menu role="menu">
    {Object.entries(languages).map(([code, name]) => {
      const targetLang = code as Language;
      const isActive = targetLang === currentLang;
      const isAvailable = !availableLanguages || availableLanguages.includes(targetLang);
      const targetUrl = getTargetUrl(targetLang);

      return (
        <a
          href={isAvailable ? targetUrl : '#'}
          class:list={[
            'dropdown-item',
            { 'active': isActive },
            { 'disabled': !isAvailable }
          ]}
          role="menuitem"
          aria-current={isActive ? 'page' : undefined}
          aria-disabled={!isAvailable}
          title={!isAvailable ? `Not available in ${name}` : undefined}
        >
          {name}
          {isActive && <span class="check-mark" aria-label="(current)">âœ“</span>}
        </a>
      );
    })}
  </div>
</div>

<style>
  .language-dropdown {
    position: relative;
  }

  .dropdown-trigger {
    display: flex;
    align-items: center;
    gap: var(--spacing-1);
    padding: var(--spacing-2) var(--spacing-3);
    background: var(--color-primary-orange);
    border: none;
    border-radius: var(--radius-md);
    color: white;
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: background-color var(--duration-fast) var(--ease-in-out);
  }

  .globe-icon {
    display: block;
    flex-shrink: 0;
  }

  .dropdown-trigger:hover {
    background-color: #e67a2e;
  }

  .dropdown-arrow {
    transition: transform var(--duration-normal) var(--ease-in-out);
  }

  .dropdown-trigger[aria-expanded="true"] .dropdown-arrow {
    transform: rotate(180deg);
  }

  .dropdown-menu {
    position: absolute;
    top: calc(100% + var(--spacing-2));
    right: 0;
    min-width: 10rem;
    background: var(--color-bg-primary);
    border: var(--border-width-thin) solid var(--color-border-secondary);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-0.5rem);
    transition: all var(--duration-normal) var(--ease-out);
    z-index: var(--z-index-dropdown);
  }

  .dropdown-menu[data-open="true"] {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-3) var(--spacing-4);
    color: var(--color-text-primary);
    text-decoration: none;
    font-size: var(--font-size-sm);
    transition: background-color var(--duration-fast) var(--ease-in-out);
    cursor: pointer;
  }

  .dropdown-item:first-child {
    border-radius: var(--radius-md) var(--radius-md) 0 0;
  }

  .dropdown-item:last-child {
    border-radius: 0 0 var(--radius-md) var(--radius-md);
  }

  .dropdown-item:hover:not(.disabled) {
    background-color: var(--color-bg-secondary);
  }

  .dropdown-item.active {
    background-color: var(--color-bg-tag);
    color: var(--color-primary-cyan);
    font-weight: var(--font-weight-medium);
  }

  .dropdown-item.disabled {
    opacity: 0.4;
    cursor: not-allowed;
    pointer-events: none;
  }

  .check-mark {
    color: var(--color-primary-cyan);
    font-weight: var(--font-weight-bold);
  }
</style>

<script>
  // Handle dropdown interactions
  document.addEventListener('DOMContentLoaded', () => {
    const dropdowns = document.querySelectorAll('[data-dropdown]');

    dropdowns.forEach((dropdown) => {
      const trigger = dropdown.querySelector('[data-dropdown-trigger]') as HTMLButtonElement;
      const menu = dropdown.querySelector('[data-dropdown-menu]') as HTMLElement;
      const items = menu.querySelectorAll('.dropdown-item:not(.disabled)') as NodeListOf<HTMLAnchorElement>;

      let isOpen = false;

      const open = () => {
        isOpen = true;
        trigger.setAttribute('aria-expanded', 'true');
        menu.setAttribute('data-open', 'true');
        // Focus first item
        (items[0] as HTMLElement)?.focus();
      };

      const close = () => {
        isOpen = false;
        trigger.setAttribute('aria-expanded', 'false');
        menu.removeAttribute('data-open');
      };

      const toggle = () => {
        if (isOpen) {
          close();
        } else {
          open();
        }
      };

      // Toggle on button click
      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        toggle();
      });

      // Close on outside click
      document.addEventListener('click', (e) => {
        if (isOpen && !dropdown.contains(e.target as Node)) {
          close();
        }
      });

      // Keyboard navigation
      trigger.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          open();
        } else if (e.key === 'Escape') {
          close();
          trigger.focus();
        }
      });

      menu.addEventListener('keydown', (e) => {
        const currentIndex = Array.from(items).indexOf(document.activeElement as HTMLAnchorElement);

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          const nextIndex = (currentIndex + 1) % items.length;
          (items[nextIndex] as HTMLElement).focus();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          const prevIndex = currentIndex <= 0 ? items.length - 1 : currentIndex - 1;
          (items[prevIndex] as HTMLElement).focus();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          close();
          trigger.focus();
        } else if (e.key === 'Tab') {
          close();
        }
      });

      // Close on item selection
      items.forEach((item) => {
        item.addEventListener('click', () => {
          close();
        });
      });
    });
  });
</script>
