---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

const lang = Astro.currentLocale || 'en';
const allPosts = await getCollection('posts', ({ slug }) => {
  return slug.startsWith(`${lang}/`);
});

// Collect all unique tags with post counts
const tagCounts = new Map<string, number>();
allPosts.forEach((post) => {
  post.data.tags.forEach((tag) => {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  });
});

// Sort tags by count (descending) and then alphabetically
const sortedTags = Array.from(tagCounts.entries())
  .sort((a, b) => {
    if (b[1] !== a[1]) return b[1] - a[1];
    return a[0].localeCompare(b[0]);
  });
---

<BaseLayout title="Tags" lang={lang}>
  <div class="tags-page">
    <h1>Browse by Tags</h1>
    <p class="subtitle">Explore posts organized by topics</p>

    <div class="tags-cloud">
      {sortedTags.map(([tag, count]) => {
        const slug = tag.toLowerCase().replace(/\s+/g, '-');
        const size = Math.min(2.5, 1 + (count / 10));
        return (
          <a
            href={`/tags/${slug}`}
            class="tag-item"
            style={`font-size: ${size}rem;`}
          >
            {tag}
            <span class="count">({count})</span>
          </a>
        );
      })}
    </div>
  </div>
</BaseLayout>

<style>
  .tags-page {
    max-width: 1200px;
    margin: 0 auto;
  }

  h1 {
    font-size: var(--font-size-4xl);
    margin-bottom: var(--spacing-2);
    color: var(--color-text-primary);
    font-weight: var(--font-weight-bold);
  }

  .subtitle {
    font-size: var(--font-size-lg);
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-12);
  }

  .tags-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-4);
    align-items: center;
    justify-content: center;
    padding: var(--spacing-8);
  }

  .tag-item {
    background: var(--color-bg-tag);
    color: var(--color-text-primary);
    padding: var(--spacing-2) var(--spacing-4);
    border-radius: var(--radius-full);
    text-decoration: none;
    font-weight: var(--font-weight-medium);
    transition: all var(--duration-fast) var(--ease-in-out);
    line-height: var(--line-height-normal);
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-1);
  }

  .tag-item:hover {
    background-color: #c7f0ed;
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
  }

  .count {
    font-size: 0.85em;
    color: var(--color-text-light);
    font-weight: var(--font-weight-normal);
  }
</style>
